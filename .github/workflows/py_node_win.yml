name: Reliable Windows Package
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        type: string

env:
  INSTALLER_NAME: travel_guide_network-${{ github.event.inputs.version }}-setup.exe

jobs:
  package:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4  # 检出代码

      - name: Setup Python 3.12  # 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js 20  # 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Inno Setup  # 安装Inno Setup
        run: choco install innosetup -y

      - name: Install Python dependencies  # 安装Python依赖
        run: python -m pip install -r requirements.txt

      - name: Create portable Python environment  # 创建可移植Python环境
        run: |
          $pythonPath = python -c "import sys; print(sys.executable)"
          $pythonDir = Split-Path -Parent $pythonPath
          New-Item -ItemType Directory -Force -Path "python"
          Copy-Item -Path "$pythonDir\*" -Destination "python" -Recurse -Force -Exclude @("*.pyc", "__pycache__")

      - name: Create portable Node.js environment  # 创建可移植Node.js环境
        run: |
          $nodePath = node -e "console.log(process.execPath)"
          $nodeDir = Split-Path -Parent $nodePath
          New-Item -ItemType Directory -Force -Path "nodejs"
          Copy-Item -Path "$nodeDir\*" -Destination "nodejs" -Recurse -Force

      - name: Create Inno Setup installer  # 创建安装包
        run: |
          $version = "${{ github.event.inputs.version }}"
          $installerScript = @"
          [Setup]
          AppName=travel_guide_network
          AppVersion=$version
          DefaultDirName={autopf}\travel_guide_network
          OutputBaseFilename=travel_guide_network-$version-setup
          Compression=lzma2
          SolidCompression=yes
          
          [Files]
          Source: "python\*"; DestDir: "{app}\python"; Flags: ignoreversion recursesubdirs
          Source: "nodejs\*"; DestDir: "{app}\nodejs"; Flags: ignoreversion recursesubdirs
          Source: "*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\travel_guide_network"; Filename: "{app}\agents\launch.py"
          "@
          $installerScript | Out-File -Encoding utf8 setup.iss
          
          $innoPath = Get-ChildItem "C:\Program Files (x86)" -Filter "Inno Setup*" -Directory | Select-Object -First 1 -ExpandProperty FullName
          & "$innoPath\ISCC.exe" setup.iss

      - name: Rename installer  # 重命名安装包
        run: |
          $version = "${{ github.event.inputs.version }}"
          Get-ChildItem -Filter "travel_guide_network-$version-setup.exe" | Rename-Item -NewName "${{ env.INSTALLER_NAME }}"

      - uses: actions/upload-artifact@v4  # 上传安装包
        with:
          name: win-installer
          path: ${{ env.INSTALLER_NAME }}

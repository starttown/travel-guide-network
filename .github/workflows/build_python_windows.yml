name: Reliable Python Package


on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.0)'
        required: true
        default: '0.1.0'

env:
  INSTALLER_NAME: TravelGuideNetwork-${{ github.event.inputs.version }}-Setup.exe

jobs:
  package:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Inno Setup
        run: choco install innosetup -y

      # å®‰è£… Python ä¾èµ– (è¿›å…¥ network ç›®å½•)
      - name: Install Python dependencies
        run: |
          cd network
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # === ä¿®æ­£ç‚¹ 1ï¼šåœ¨ network ç›®å½•ä¸‹åˆ›å»º python_runtime ===
      - name: Create portable Python environment
        shell: pwsh
        run: |
          $pythonExePath = python -c "import sys; print(sys.executable)"
          $pythonRoot = Split-Path -Parent (Split-Path -Parent $pythonExePath)
          
          Write-Host "Detected Python Root: $pythonRoot"
          
          # ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šè·¯å¾„æ”¹ä¸º network/python_runtime
          New-Item -ItemType Directory -Force -Path "network\python_runtime"
          
          # ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šæ‹·è´åˆ° network\python_runtime
          Copy-Item -Path "$pythonRoot\*" -Destination "network\python_runtime" -Recurse -Force -Exclude @("*.pyc", "__pycache__", "*.chm")

      # åŠ¨æ€ç”Ÿæˆ setup.iss (æ”¾åœ¨ network ç›®å½•ä¸‹)
      - name: Create Inno Setup installer
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          
          $installerScript = @"
          ; Travel Guide Network - å®‰è£…è„šæœ¬ (ä½äº network ç›®å½•ä¸‹)
          
          [Setup]
          AppName=Travel Guide Network
          AppVersion=$version
          DefaultDirName={pf}\TravelGuideNetwork
          DefaultGroupName=Travel Guide Network
          OutputBaseFilename=TravelGuideNetwork-$version-Setup
          OutputDir=.\Output
          Compression=lzma2
          SolidCompression=yes
          PrivilegesRequired=admin
          UninstallDisplayIcon={app}\run_network.bat
          
          [Files]
          ; æ‰“åŒ…å½“å‰ç›®å½• (network) ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          Source: "*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs; Excludes: "*.log,Output,installer.iss"
          
          ; ğŸ‘‡ ä¿®æ­£ç‚¹ 2ï¼šä¸å†éœ€è¦ .. äº†ï¼Œpython_runtime å°±åœ¨å½“å‰ç›®å½•ä¸‹
          Source: "python_runtime\*"; DestDir: "{app}\python_runtime"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\New Travel Guide"; Filename: "{app}\run_network.bat"
          Name: "{commondesktop}\New Travel Guide"; Filename: `"{app}\run_network.bat`"
          
          [Run]
          ; å®‰è£…å®Œæˆåä¸è‡ªåŠ¨å¯åŠ¨
          
          [UninstallDelete]
          Type: filesandordirs; Name: "{app}\logs"
          Type: filesandpowershelldirs; Name: "{app}\__pycache__"
          "@
          
          # å†™å…¥åˆ° network/setup.iss
          åœ¨è¿™åé¢åŠ ä¸ª `cd network` æˆ–è€…ä¿®æ”¹ Out-File è·¯å¾„
          $installerScript | Out-File -Encoding utf8 "network\setup.iss"
          
          # ç¼–è¯‘ (å¿…é¡»æŒ‡å®šç¼–è¯‘é‚£ä¸ªç›®å½•ä¸‹çš„ iss)
          # ISCC æ¥å—ç›¸å¯¹è·¯å¾„ï¼Œå½“å‰ç›®å½•æ˜¯æ ¹ç›®å½•ï¼Œæ‰€ä»¥æ˜¯ network\setup.iss
          $innoPath = Get-ChildItem "C:\Program Files (x86)" -Source: "C:\Program Files (x86)" -Filter "Inno Setup 6" -Directory | Select-Object -First 1 -ExpandProperty FullName
          # ğŸ‘‡ ä¿®æ­£ç‚¹ 3ï¼šç¡®ä¿ ISCC æ‰¾åˆ°æ­£ç¡®çš„ iss æ–‡ä»¶
          & "$innoPath\ISCC.exe" "network\setup.iss"

      - uses: artifacts/upload-artifact@v4
        with:
          name: win-installer
         
          path: network\Output\*.exe
